<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="d3.v7.js"></script>
    <title>CS416 Narrative Visualization</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&family=Rubik:ital,wght@0,400;1,800&display=swap"
        rel="stylesheet">
    <style>
        .bold {
            font-family: 'Roboto', sans-serif;
            font-weight: 400;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <h2>Average Math Score grouped by Gender</h2>
    <svg width="600" height="400"></svg>

    <script>
        // Load data from CSV file
        d3.csv("StudentsPerformance.csv").then(function(data) {
            data.forEach(d => {
                d["math score"] = +d["math score"];
            });

            // Calculate average scores for each group
            const genderAvg = d3.rollup(data, v => d3.mean(v, d => d["math score"]), d => d.gender);
            const raceAvg = d3.rollup(data, v => d3.mean(v, d => d["math score"]), d => d["race/ethnicity"]);
            const educationAvg = d3.rollup(data, v => d3.mean(v, d => d["math score"]), d => d["parental level of education"]);
            const lunchAvg = d3.rollup(data, v => d3.mean(v, d => d["math score"]), d => d.lunch);
            const prepAvg = d3.rollup(data, v => d3.mean(v, d => d["math score"]), d => d["test preparation course"]);

            const processedData = [
                ...Array.from(genderAvg, ([key, value]) => ({ group: "Gender", category: key, average: value })),
                ...Array.from(raceAvg, ([key, value]) => ({ group: "Ethnicity", category: key, average: value })),
                ...Array.from(educationAvg, ([key, value]) => ({ group: "Parental Education Level", category: key, average: value })),
                ...Array.from(lunchAvg, ([key, value]) => ({ group: "Lunch Type", category: key, average: value })),
                ...Array.from(prepAvg, ([key, value]) => ({ group: "Test Preparation", category: key, average: value })),
            ];

            
            const margin = {top: 20, right: 30, bottom: 150, left: 40};
            const width = +svg.attr("width") - margin.left - margin.right;
            const height = +svg.attr("height") - margin.top - margin.bottom;
            var svg = d3.select("#bar-chart").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


            const x0 = d3.scaleBand()
                .domain(processedData.map(d => d.group))
                .rangeRound([0, width])
                .paddingInner(0.1);

            const x1 = d3.scaleBand()
                .domain(processedData.map(d => d.category))
                .rangeRound([0, x0.bandwidth()])
                .padding(0.05);

            const y = d3.scaleLinear()
                .domain([0, d3.max(processedData, d => d.average)])
                .nice()
                .rangeRound([height, 0]);

            const color = d3.scaleOrdinal()
                .domain(processedData.map(d => d.category))
                .range(d3.schemeCategory10);

            const tooltip = d3.select(".tooltip");

            xScale.domain(data.map(xValue));
                svg.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + height + ")")
                    .call(xAxis)
                    .selectAll("text")
                    .style("text-anchor", "end")
                    .attr("dx", "-.8em")
                    .attr("dy", ".15em")
                    .attr("transform", "rotate(-45)");

                //y
                console.log(d3.max(data, yValue));
                yAxisScale.domain([0, d3.max(data, yValue)]);
                svg.append("g")
                    .attr("class", "y axis")
                    .call(yAxis);

                //x label
                svg.append("text")
                    .attr("transform", "translate(" + (width / 2) + " ," + (height + margin.top + 90) + ")")
                    .style("text-anchor", "middle")
                    .text("Color")
                    .attr('class', 'bold');

                //y label
                svg.append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 0 - margin.left + 10)
                    .attr("x", 0 - (height / 2))
                    .attr("dy", "1em")
                    .style("text-anchor", "middle")
                    .text("Quantity")
                    .attr('class', 'bold');

                // bars
                svg.selectAll(".bar")
                    .data(data)
                    .enter().append("rect")
                    .attr("class", "bar")
                    .attr("x", xMap)
                    .attr("width", xScale.bandwidth())
                    .attr("y", height) 
                    .attr("height", 0)
                    .style("fill", cValue)
                    .on("mouseover", function (event, d) {
                        d3.select("#tooltip")
                            .select("#value")
                            .html("<b>Color: </b>" + d.name + "<br/>" + "<b>Quantity: </b>" + d.quantity);
                        d3.select("#tooltip").style("opacity", 1);
                        d3.select(this).style("stroke", "black").style("stroke-width", "2px");
                    })
                    .on("mouseout", function () {
                        d3.select("#tooltip").style("opacity", 0);
                        d3.select(this).style("stroke", "none");
                    })
                    .transition() 
                    .delay(500)
                    .duration(3000)
                    .attr("y", yMap) 
                    .attr("height", function (d) { return height - yMap(d); }); 

            });
        </script>
    <p class="center">Stuff</p>

    <br><br>

    <a href="scene2.html" style="text-decoration:none;"><button class="center">Next</button></a>
    <a href="index.html" style="text-decoration:none;"><button class="center"
            style="outline: 2px; outline-color: black; background-color: #0055BF; margin-bottom: 50px;">Back</button></a>

    <br><br><br>
    <div class="footer">
        <h4>Maxwell Wieboldt (mgw10)</h4>
        <h4>Dataset: https://www.kaggle.com/datasets/spscientist/students-performance-in-exams/data</h4>
    </div>

</body>

</html>