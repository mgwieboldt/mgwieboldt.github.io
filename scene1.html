<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="d3.v7.js"></script>
    <title>CS416 Narrative Visualization</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&family=Rubik:ital,wght@0,400;1,800&display=swap"
        rel="stylesheet">
    <style>
        .bold {
            font-family: 'Roboto', sans-serif;
            font-weight: 400;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <h2>Average Math Score grouped by Gender</h2>
    <svg width="1200" height="600"></svg>

    <div id="tooltip">
        <p><span id="value"></span></p>
    </div>

    <script>
        // Load data from CSV file
        d3.csv("StudentsPerformance.csv").then(function(data) {
            data.forEach(d => {
                d["math score"] = +d["math score"];
            });

            // Calculate average scores for each group
            const genderAvg = d3.rollup(data, v => d3.mean(v, d => d["math score"]), d => d.gender);
            const raceAvg = d3.rollup(data, v => d3.mean(v, d => d["math score"]), d => d["race/ethnicity"]);
            const educationAvg = d3.rollup(data, v => d3.mean(v, d => d["math score"]), d => d["parental level of education"]);
            const lunchAvg = d3.rollup(data, v => d3.mean(v, d => d["math score"]), d => d.lunch);
            const prepAvg = d3.rollup(data, v => d3.mean(v, d => d["math score"]), d => d["test preparation course"]);

            const processedData = [
                ...Array.from(genderAvg, ([key, value]) => ({ group: "Gender", category: key, average: value })),
                ...Array.from(raceAvg, ([key, value]) => ({ group: "Ethnicity", category: key, average: value })),
                ...Array.from(educationAvg, ([key, value]) => ({ group: "Parental Education Level", category: key, average: value })),
                ...Array.from(lunchAvg, ([key, value]) => ({ group: "Lunch Type", category: key, average: value })),
                ...Array.from(prepAvg, ([key, value]) => ({ group: "Test Preparation", category: key, average: value })),
            ];

            const svg = d3.select("svg");
            const margin = {top: 20, right: 30, bottom: 150, left: 40};
            const width = +svg.attr("width") - margin.left - margin.right;
            const height = +svg.attr("height") - margin.top - margin.bottom;
            const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);


            const x0 = d3.scaleBand()
                .domain(processedData.map(d => d.group))
                .range([0, width])
                .paddingInner(0);

            const x1 = d3.scaleBand()
                .domain(processedData.map(d => d.category))
                .range([0, x0.bandwidth()])
                .padding(0);

            var xValue = function (d) { return d.category; },
                xScale = d3.scaleBand().range([0, x0.bandwidth()]).padding(0.1),
                xMap = function (d) { return xScale(xValue(d)); },
                xAxis = d3.axisBottom(xScale);

            const y = d3.scaleLinear()
                .domain([0, 100])
                .nice()
                .rangeRound([height, 0]);

            const color = d3.scaleOrdinal()
                .domain(processedData.map(d => d.category))
                .range(d3.schemeCategory10);

            const tooltip = d3.select(".tooltip");
            xScale.domain(data.map(xValue));
            g.append("g")
                .selectAll("g")
                .data(d3.group(processedData, d => d.group))
                .enter().append("g")
                .attr("transform", d => `translate(${x0(d[0])},0)`)
                .selectAll("rect")
                .data(d => d[1])
                .enter().append("rect")
                .attr("x", d => x1(d.category))
                .attr("y", d => y(d.average))
                .attr("width", xScale.bandwidth())
                .attr("height", d => height - y(d.average))
                .attr("fill", d => color(d.category))
                .on("mouseover", function(event, d) {
                    d3.select("#tooltip")
                            .select("#value")
                            .html("<b>" + d.group + ": </b>" + d.category + "<br/>" + "<b>Average Score: </b>" + d.average.toFixed(2));
                        d3.select("#tooltip").style("opacity", 1);
                        d3.select(this).style("stroke", "black").style("stroke-width", "2px");
                })
                .on("mouseout", function () {
                        d3.select("#tooltip").style("opacity", 0);
                        d3.select(this).style("stroke", "none");
                    });

            g.append("g")
                .attr("class", "axis axis--x")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x0))
                .selectAll("text")
                .attr("transform", "rotate(-45)")
                .attr("text-anchor", "end");

            g.append("g")
                .attr("class", "axis axis--y")
                .call(d3.axisLeft(y))
                .append("text")
                .attr("class", "axis-label")
                .attr("transform", "rotate(-90)")
                .attr("y", -margin.left + 10)
                .attr("dy", "0.71em")
                .attr("fill", "#000")
                .text("Average Score");
        });
    </script>
    <p class="center">Stuff</p>

    <br><br>

    <a href="scene2.html" style="text-decoration:none;"><button class="center">Next</button></a>
    <a href="index.html" style="text-decoration:none;"><button class="center"
            style="outline: 2px; outline-color: black; background-color: #0055BF; margin-bottom: 50px;">Back</button></a>

    <br><br><br>
    <div class="footer">
        <h4>Maxwell Wieboldt (mgw10)</h4>
        <h4>Dataset: https://www.kaggle.com/datasets/spscientist/students-performance-in-exams/data</h4>
    </div>

</body>

</html>