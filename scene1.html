<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="d3.v7.js"></script>
    <title>CS416 Narrative Visualization</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&family=Rubik:ital,wght@0,400;1,800&display=swap"
        rel="stylesheet">
    <style>
        .bold {
            font-family: 'Roboto', sans-serif;
            font-weight: 400;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <h2>Average Math Score grouped by Gender</h2>
    <svg width="600" height="400"></svg>

    <script>
        // Load data from CSV file
        d3.csv("StudentsPerformance.csv").then(function(data) {
            data.forEach(d => {
                d["math score"] = +d["math score"];
            });

            const groupedData = d3.rollup(data,
                v => d3.mean(v, d => d["math score"]),
                d => d.gender,
                d => d.lunch,
                d => d["test preparation course"]
            );

            const processedData = [];
            groupedData.forEach((lunch, gender) => {
                lunch.forEach((prep, lunchType) => {
                    prep.forEach((score, prepType) => {
                        processedData.push({
                            gender: gender,
                            lunch: lunchType,
                            preparation: prepType,
                            average: score
                        });
                    });
                });
            });

            const svg = d3.select("svg");
            const margin = {top: 20, right: 30, bottom: 120, left: 40};
            const width = +svg.attr("width") - margin.left - margin.right;
            const height = +svg.attr("height") - margin.top - margin.bottom;
            const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            const x0 = d3.scaleBand()
                .domain(processedData.map(d => `${d.gender}-${d.lunch}-${d.preparation}`))
                .rangeRound([0, width])
                .paddingInner(0.1);

            const y = d3.scaleLinear()
                .domain([0, d3.max(processedData, d => d.average)])
                .nice()
                .rangeRound([height, 0]);

            const tooltip = d3.select(".tooltip");

            g.append("g")
                .selectAll(".bar")
                .data(processedData)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", d => x0(`${d.gender}-${d.lunch}-${d.preparation}`))
                .attr("y", d => y(d.average))
                .attr("width", x0.bandwidth())
                .attr("height", d => height - y(d.average))
                .on("mouseover", function(event, d) {
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", .9);
                    tooltip.html(`Gender: ${d.gender}<br>Lunch: ${d.lunch}<br>Preparation: ${d.preparation}<br>Average: ${d.average.toFixed(2)}`)
                        .style("left", (event.pageX) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function(d) {
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            g.append("g")
                .attr("class", "axis axis--x")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x0))
                .selectAll("text")
                .attr("transform", "rotate(-65)")
                .attr("text-anchor", "end")
                .append("text")
                .attr("class", "axis-label")
                .attr("x", width / 2)
                .attr("y", margin.bottom - 10)
                .attr("fill", "#000");

            g.append("g")
                .attr("class", "axis axis--y")
                .call(d3.axisLeft(y))
                .append("text")
                .attr("class", "axis-label")
                .attr("transform", "rotate(-90)")
                .attr("y", -margin.left + 10)
                .attr("dy", "0.71em")
                .attr("fill", "#000")
                .text("Average Score");
        });
    </script>

    <p class="center">Stuff</p>

    <br><br>

    <a href="scene2.html" style="text-decoration:none;"><button class="center">Next</button></a>
    <a href="index.html" style="text-decoration:none;"><button class="center"
            style="outline: 2px; outline-color: black; background-color: #0055BF; margin-bottom: 50px;">Back</button></a>

    <br><br><br>
    <div class="footer">
        <h4>Maxwell Wieboldt (mgw10)</h4>
        <h4>Dataset: https://www.kaggle.com/datasets/spscientist/students-performance-in-exams/data</h4>
    </div>

</body>

</html>